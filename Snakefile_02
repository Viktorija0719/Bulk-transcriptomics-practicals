configfile: "config_2.yaml"
import os


os.makedirs("data/indexed", exist_ok=True)
os.makedirs("mapping/mapping_1", exist_ok=True)
os.makedirs("mapping/index_1", exist_ok=True)
os.makedirs("mapping/sort_1", exist_ok=True)
os.makedirs("count/", exist_ok=True)


rule all:
    input:
        expand("mapping/mapping_1/{sample}.Aligned.sortedByCoord.out.bam", sample=config['samples']),
        expand("mapping/index_1/{sample}.sorted.bam.bai", sample=config['samples']),
        expand("count/counts/{sample}_counts.txt", sample=config['samples']),


rule star_genome_index:
    input:
        fasta="data/data_ref_annot/chr19_20Mb.fa",
        gtf="data/data_ref_annot/chr19_20Mb.gtf"
    output:
        directory("data/indexed")
    params:
        genomeSAindexNbases=11
    threads: 16
    shell:
        """
        STAR --runThreadN {threads} \
             --runMode genomeGenerate \
             --genomeDir {output} \
             --genomeFastaFiles {input.fasta} \
             --sjdbGTFfile {input.gtf} \
             --genomeSAindexNbases {params.genomeSAindexNbases}
        """



rule star_align:
    input:
        r1="data/processed/{sample}_R1_001_trimmed.fastq.gz",
        r2="data/processed/{sample}_R2_001_trimmed.fastq.gz",
        index_dir=directory("data/indexed")
    output:
        bam="mapping/mapping_1/{sample}.Aligned.sortedByCoord.out.bam"
    threads: config['star']['runThreadN']
    shell:
        """
        STAR --genomeDir {input.index_dir} \
             --readFilesIn {input.r1} {input.r2} \
             --readFilesCommand zcat \
             --outSAMtype BAM SortedByCoordinate \
             --outFileNamePrefix mapping/mapping_1/{wildcards.sample}. \
             --runThreadN {threads}
        """


rule samtools_sort:
    input:
        "mapping/mapping_1/{sample}.Aligned.sortedByCoord.out.bam"
    output:
        sorted_bam="mapping/index_1/{sample}.sorted.bam"
    shell:
        "samtools sort -o {output.sorted_bam} {input}"


rule samtools_index:
    input:
        "mapping/index_1/{sample}.sorted.bam"
    output:
        "mapping/index_1/{sample}.sorted.bam.bai"
    shell:
        "samtools index {input}"


def get_strand_specificity(sample):
    if "_R1_" in sample:
        return "1"  # Forward strand
    elif "_R2_" in sample:
        return "2"  # Reverse strand
    else:
        return "0"  # Unstranded


rule featureCounts:
    input:
        bam="mapping/index_1/{sample}.sorted.bam",  # Adjusted to match the sorted BAM file path
        annotation=config['featureCounts']['annotation']
    output:
        counts="count/counts/{sample}_counts.txt"
    params:
        strand_specificity=lambda wildcards: get_strand_specificity(wildcards.sample),
    shell:
        """
        featureCounts -a {input.annotation} -o {output.counts} -s {params.strand_specificity} -p -t exon -g gene_id {input.bam}
        """


