configfile: "config_1.yaml"
import os

os.makedirs("data/processed", exist_ok=True)
os.makedirs("quality/raw_fastqc", exist_ok=True)
os.makedirs("quality/raw_multiqc", exist_ok=True)
os.makedirs("quality/proc_fastqc", exist_ok=True)
os.makedirs("quality/proc_multiqc", exist_ok=True)

rule all:
    input:
        expand("quality/proc_multiqc/multiqc_trimmed_report.html", sample=config['samples']),
        expand("quality/raw_multiqc/multiqc_report.html", sample=config['samples'])

rule fastqc_raw:
    input:
        "data/RNA-seq-sample-data/{sample}.fastq.gz"
    output:
        html="quality/raw_fastqc/{sample}_fastqc.html",
        zip="quality/raw_fastqc/{sample}_fastqc.zip"
    shell:
        "fastqc {input} --outdir quality/raw_fastqc"

rule multiqc_raw:
    input:
        expand("quality/raw_fastqc/{sample}_fastqc.zip", sample=config['samples'])
    output:
        "quality/raw_multiqc/multiqc_report.html"
    shell:
        "multiqc quality/raw_fastqc/ --filename {output} -f"

rule bbduk_trim:
    input:
        reads="data/RNA-seq-sample-data/{sample}.fastq.gz",
        adapters=config['directories']['adapters']
    output:
        "data/processed/{sample}_trimmed.fastq.gz"
    shell:
        """
        bbduk.sh \
            in={input.reads} \
            out={output} \
            ref={input.adapters} \
            ktrim=r \
            k=23 \
            mink=11 \
            hdist=1 \
            tpe=t \
            tbo=t \
            qtrim=r \
            trimq=10
        """

rule fastqc_processed:
    input:
        "data/processed/{sample}_trimmed.fastq.gz"
    output:
        html="quality/proc_fastqc/{sample}_trimmed_fastqc.html",
        zip="quality/proc_fastqc/{sample}_trimmed_fastqc.zip"
    shell:
        "fastqc {input} --outdir quality/proc_fastqc"

rule multiqc_processed:
    input:
        expand("quality/proc_fastqc/{sample}_trimmed_fastqc.zip", sample=config['samples'])
    output:
        "quality/proc_multiqc/multiqc_trimmed_report.html"
    shell:
        "multiqc quality/proc_fastqc/ --filename multiqc_trimmed_report.html -o quality/proc_multiqc/"
